version: 2.1

refs:
  - &only_master
    filters:
      branches:
        only: master

  - &not_master
    filters:
      branches:
        ignore: master

workflows:
  test:
    jobs:
      - unit-tests:
          <<: *not_master

  release:
    jobs:
      - deploy-staging:
          <<: *only_master
          context: common-env

      - production-approval:
          type: approval
          context: common-env
          requires:
            - deploy-staging

      - deploy-production:
          <<: *only_master
          context: common-env
          requires:
            - production-approval

jobs:
  unit-tests:
    docker:
      - image: circleci/node:12
    steps:
      - setup
      - build
      - test

  deploy-staging:
    docker:
      - image: circleci/node:12
    steps:
      - setup
      - build
      - authenticate
      - push
      - deploy-staging

  deploy-production:
    docker:
      - image: circleci/node:12
    steps:
      - authenticate
      - deploy-production

commands:
  setup:
    description: 'Checkout and install dependencies'
    steps:
      - checkout
      - run:
          name: Versions
          command: node -v && npm -v && yarn -v
      - run:
          name: Install Dependencies
          command: yarn install --pure-lockfile

  build:
    steps:
      - run:
          name: Build
          command: yarn build

  test:
    steps:
      - run:
          name: Test
          command: yarn test

  authenticate:
    steps:
      - add_ssh_keys:
          fingerprints:
            - '2f:e6:90:bb:61:85:fe:d5:9a:1a:27:77:9e:09:8d:fd'
      - run:
          name: Test Connection
          command: ssh -o StrictHostKeyChecking=no root@$DOKKU_SERVER "dokku version"

  push:
    steps:
      - setup_remote_docker
      - run:
          name: Build Docker
          command: docker build -t dokku/$CIRCLE_PROJECT_REPONAME:$CIRCLE_SHA1 .
      - run:
          name: Push Docker
          command: npx docker-over-ssh push dokku/$CIRCLE_PROJECT_REPONAME:$CIRCLE_SHA1 |  ssh dokku "docker-over-ssh pull dokku/$CIRCLE_PROJECT_REPONAME:$CIRCLE_SHA1"

  deploy-staging:
    steps:
      - run:
          name: Tag Docker (Staging)
          command: ssh ci@$DOKKU_SERVER "docker tag dokku/$CIRCLE_PROJECT_REPONAME:$CIRCLE_SHA1 dokku/$CIRCLE_PROJECT_REPONAME-staging:$CIRCLE_SHA1"
      - run:
          name: Update Server (Staging)
          command: ssh ci@$DOKKU_SERVER "dokku tags:deploy $CIRCLE_PROJECT_REPONAME-staging $CIRCLE_SHA1"

  deploy-production:
    steps:
      - run:
          name: Update Server (Production)
          command: ssh ci@$DOKKU_SERVER "dokku tags:deploy $CIRCLE_PROJECT_REPONAME $CIRCLE_SHA1"
